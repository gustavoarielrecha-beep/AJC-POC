version: '3.8'

services:
  web:
    image: node:20-alpine
    working_dir: /app
    # Using a command to install deps and run the custom server script
    command: sh -c "npm install -g npm@11.6.4 && npm install && node server.js"
    volumes:
      - .:/app
      - ./cert_ajc.crt:/app/cert_ajc.crt
      - ./cert_ajc.key:/app/cert_ajc.key
    ports:
      - "3005:3005"
      - "3006:3006"
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
    environment:
      - NODE_ENV=development
      # Path inside the container where Docker injects the secret
      - AI_API_KEY_FILE=/run/secrets/ajc_ai_api_key
    secrets:
      - ajc_ai_api_key

secrets:
  ajc_ai_api_key:
    external: true