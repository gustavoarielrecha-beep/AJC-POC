-- 1. Create ENUMs for data consistency
CREATE TYPE user_role AS ENUM ('admin', 'logistics', 'sales', 'viewer');
CREATE TYPE shipment_status AS ENUM ('In Transit', 'Delivered', 'Pending', 'Customs');
CREATE TYPE product_category AS ENUM ('Poultry', 'Pork', 'Beef', 'Seafood', 'Vegetables', 'Fries');

-- 2. Profiles Table (Extends Supabase auth.users)
CREATE TABLE public.profiles (
  id UUID REFERENCES auth.users(id) ON DELETE CASCADE PRIMARY KEY,
  email TEXT,
  full_name TEXT,
  avatar_url TEXT,
  role user_role DEFAULT 'viewer',
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- 3. Products Table (Inventory)
CREATE TABLE public.products (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  name TEXT NOT NULL,
  category product_category NOT NULL,
  stock_level INTEGER DEFAULT 0,
  unit TEXT DEFAULT 'MT', -- Metric Ton
  location TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- 4. Shipments Table (Logistics)
CREATE TABLE public.shipments (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  tracking_number TEXT UNIQUE NOT NULL, -- Ex: SH-2024-001
  origin TEXT NOT NULL,
  destination TEXT NOT NULL,
  status shipment_status DEFAULT 'Pending',
  product_name TEXT,
  eta DATE,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Function to handle new users
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS trigger
LANGUAGE plpgsql
SECURITY DEFINER SET search_path = public
AS $$
BEGIN
  INSERT INTO public.profiles (id, email, full_name, avatar_url, role)
  VALUES (
    new.id, 
    new.email, 
    COALESCE(new.raw_user_meta_data->>'full_name', new.raw_user_meta_data->>'name', split_part(new.email, '@', 1)),
    new.raw_user_meta_data->>'avatar_url',
    'viewer' -- Default role
  );
  RETURN new;
END;
$$;

-- Trigger fired after auth.users creation
CREATE OR REPLACE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW EXECUTE PROCEDURE public.handle_new_user();
  
-- Enable RLS on all tables
ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.products ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.shipments ENABLE ROW LEVEL SECURITY;

-- Policies for Profiles
CREATE POLICY "Profiles visible to all authenticated users" 
ON public.profiles FOR SELECT TO authenticated USING (true);

CREATE POLICY "Users can edit their own profile" 
ON public.profiles FOR UPDATE TO authenticated USING (auth.uid() = id);

-- Policies for Products (Read for all, Write open for POC)
CREATE POLICY "Products visible to all" 
ON public.products FOR SELECT TO authenticated USING (true);

CREATE POLICY "Product management allowed" 
ON public.products FOR ALL TO authenticated USING (true);

-- Policies for Shipments
CREATE POLICY "Shipments visible to all" 
ON public.shipments FOR SELECT TO authenticated USING (true);

CREATE POLICY "Shipment management allowed" 
ON public.shipments FOR ALL TO authenticated USING (true);


-- Insert Products
INSERT INTO public.products (name, category, stock_level, unit, location) VALUES
('Frozen Whole Chicken', 'Poultry', 1200, 'MT', 'Atlanta Cold Storage'),
('Pork Shoulder', 'Pork', 850, 'MT', 'Rotterdam Port'),
('French Fries 9x9', 'Fries', 500, 'MT', 'Antwerp Warehouse'),
('Tilapia Fillets', 'Seafood', 300, 'MT', 'Santos Terminal');

-- Insert Shipments
INSERT INTO public.shipments (tracking_number, origin, destination, status, product_name, eta) VALUES
('SH-2024-001', 'Santos, BR', 'Shanghai, CN', 'In Transit', 'Poultry', '2024-04-15'),
('SH-2024-002', 'Rotterdam, NL', 'Lagos, NG', 'Customs', 'Fries', '2024-03-28'),
('SH-2024-003', 'Jacksonville, US', 'San Juan, PR', 'Pending', 'Pork', '2024-04-02'),
('SH-2024-004', 'Busan, KR', 'Tokyo, JP', 'In Transit', 'Seafood', '2024-03-30');